<?xml version="1.0" encoding="UTF-8"?>
<questel-patent-document lang="en" date-produced="20180805" produced-by="Questel" schema-version="3.23" file="US06181753B2.xml">
  <bibliographic-data lang="en">
    <publication-reference publ-desc="Granted patent as second publication">
      <document-id>
        <country>US</country>
        <doc-number>06181753</doc-number>
        <kind>B2</kind>
        <date>20010130</date>
      </document-id>
      <document-id data-format="questel">
        <doc-number>US6181753</doc-number>
      </document-id>
    </publication-reference>
    <original-publication-kind>B2</original-publication-kind>
    <application-reference family-id="14581962" extended-family-id="4707057">
      <document-id>
        <country>US</country>
        <doc-number>09055319</doc-number>
        <kind>A</kind>
        <date>19980406</date>
      </document-id>
      <document-id data-format="questel">
        <doc-number>1998US-09055319</doc-number>
      </document-id>
      <document-id data-format="questel_Uid">
        <doc-number>4897643</doc-number>
      </document-id>
    </application-reference>
    <language-of-filing>en</language-of-filing>
    <language-of-publication>en</language-of-publication>
    <priority-claims>
      <priority-claim kind="national" sequence="1">
        <country>JP</country>
        <doc-number>11224897</doc-number>
        <kind>A</kind>
        <date>19970430</date>
        <priority-active-indicator>Y</priority-active-indicator>
      </priority-claim>
      <priority-claim data-format="questel" sequence="1">
        <doc-number>1997JP-0112248</doc-number>
      </priority-claim>
    </priority-claims>
    <dates-of-public-availability>
      <publication-of-grant-date>
        <date>20010130</date>
      </publication-of-grant-date>
    </dates-of-public-availability>
    <classifications-ipcr>
      <classification-ipcr sequence="1">
        <text>H04M   9/08        20060101A I20051008RMEP</text>
        <ipc-version-indicator>
          <date>20060101</date>
        </ipc-version-indicator>
        <classification-level>A</classification-level>
        <section>H</section>
        <class>04</class>
        <subclass>M</subclass>
        <main-group>9</main-group>
        <subgroup>08</subgroup>
        <classification-value>I</classification-value>
        <generating-office>
          <country>EP</country>
        </generating-office>
        <classification-status>R</classification-status>
        <classification-data-source>M</classification-data-source>
        <action-date>
          <date>20051008</date>
        </action-date>
      </classification-ipcr>
      <classification-ipcr sequence="2">
        <text>H04R   3/02        20060101AFI20051220RMJP</text>
        <ipc-version-indicator>
          <date>20060101</date>
        </ipc-version-indicator>
        <classification-level>A</classification-level>
        <section>H</section>
        <class>04</class>
        <subclass>R</subclass>
        <main-group>3</main-group>
        <subgroup>02</subgroup>
        <symbol-position>F</symbol-position>
        <classification-value>I</classification-value>
        <generating-office>
          <country>JP</country>
        </generating-office>
        <classification-status>R</classification-status>
        <classification-data-source>M</classification-data-source>
        <action-date>
          <date>20051220</date>
        </action-date>
      </classification-ipcr>
      <classification-ipcr sequence="3">
        <text>G10K  11/178       20060101ALI20051220RMJP</text>
        <ipc-version-indicator>
          <date>20060101</date>
        </ipc-version-indicator>
        <classification-level>A</classification-level>
        <section>G</section>
        <class>10</class>
        <subclass>K</subclass>
        <main-group>11</main-group>
        <subgroup>178</subgroup>
        <symbol-position>L</symbol-position>
        <classification-value>I</classification-value>
        <generating-office>
          <country>JP</country>
        </generating-office>
        <classification-status>R</classification-status>
        <classification-data-source>M</classification-data-source>
        <action-date>
          <date>20051220</date>
        </action-date>
      </classification-ipcr>
      <classification-ipcr sequence="4">
        <text>G10L  19/00        20060101ALI20051220RMJP</text>
        <ipc-version-indicator>
          <date>20060101</date>
        </ipc-version-indicator>
        <classification-level>A</classification-level>
        <section>G</section>
        <class>10</class>
        <subclass>L</subclass>
        <main-group>19</main-group>
        <subgroup>00</subgroup>
        <symbol-position>L</symbol-position>
        <classification-value>I</classification-value>
        <generating-office>
          <country>JP</country>
        </generating-office>
        <classification-status>R</classification-status>
        <classification-data-source>M</classification-data-source>
        <action-date>
          <date>20051220</date>
        </action-date>
      </classification-ipcr>
      <classification-ipcr sequence="5">
        <text>H04B   3/23        20060101ALI20051220RMJP</text>
        <ipc-version-indicator>
          <date>20060101</date>
        </ipc-version-indicator>
        <classification-level>A</classification-level>
        <section>H</section>
        <class>04</class>
        <subclass>B</subclass>
        <main-group>3</main-group>
        <subgroup>23</subgroup>
        <symbol-position>L</symbol-position>
        <classification-value>I</classification-value>
        <generating-office>
          <country>JP</country>
        </generating-office>
        <classification-status>R</classification-status>
        <classification-data-source>M</classification-data-source>
        <action-date>
          <date>20051220</date>
        </action-date>
      </classification-ipcr>
      <classification-ipcr sequence="6">
        <text>H04M   1/60        20060101ALI20051220RMJP</text>
        <ipc-version-indicator>
          <date>20060101</date>
        </ipc-version-indicator>
        <classification-level>A</classification-level>
        <section>H</section>
        <class>04</class>
        <subclass>M</subclass>
        <main-group>1</main-group>
        <subgroup>60</subgroup>
        <symbol-position>L</symbol-position>
        <classification-value>I</classification-value>
        <generating-office>
          <country>JP</country>
        </generating-office>
        <classification-status>R</classification-status>
        <classification-data-source>M</classification-data-source>
        <action-date>
          <date>20051220</date>
        </action-date>
      </classification-ipcr>
    </classifications-ipcr>
    <classification-national>
      <country>US</country>
      <main-classification>
        <text>375346000</text>
        <class>375</class>
        <subclass>346000</subclass>
      </main-classification>
      <further-classification sequence="1">
        <text>370286000</text>
        <class>370</class>
        <subclass>286000</subclass>
      </further-classification>
      <further-classification sequence="2">
        <text>379406080</text>
        <class>379</class>
        <subclass>406080</subclass>
      </further-classification>
      <further-classification sequence="3">
        <text>381071100</text>
        <class>381</class>
        <subclass>071100</subclass>
      </further-classification>
    </classification-national>
    <classifications-ecla>
      <classification-ecla sequence="1">
        <text>H04M-009/08C</text>
        <section>H</section>
        <class>04</class>
        <subclass>M</subclass>
        <main-group>009</main-group>
        <subgroup>08C</subgroup>
      </classification-ecla>
    </classifications-ecla>
    <patent-classifications>
      <patent-classification sequence="1">
        <classification-scheme office="EP" scheme="CPC">
          <date>20130101</date>
        </classification-scheme>
        <classification-symbol>H04M-009/082</classification-symbol>
        <section>H</section>
        <class>04</class>
        <subclass>M</subclass>
        <main-group>9</main-group>
        <subgroup>082</subgroup>
        <symbol-position>F</symbol-position>
        <classification-value>I</classification-value>
        <classification-status>B</classification-status>
        <classification-data-source>H</classification-data-source>
        <action-date>
          <date>20130101</date>
        </action-date>
      </patent-classification>
    </patent-classifications>
    <number-of-claims>8</number-of-claims>
    <exemplary-claim>1</exemplary-claim>
    <figures>
      <number-of-drawing-sheets>5</number-of-drawing-sheets>
      <number-of-figures>5</number-of-figures>
      <image-key data-format="questel">US6181753</image-key>
    </figures>
    <invention-title format="original" lang="en" id="title_en">Echo/noise canceler with delay compensation</invention-title>
    <references-cited>
      <citation srep-phase="examiner">
        <patcit num="1">
          <text>IIZUKA SHIGERU, et al</text>
          <document-id>
            <country>US</country>
            <doc-number>5315585</doc-number>
            <kind>A</kind>
          </document-id>
          <document-id data-format="questel">
            <doc-number>US5315585</doc-number>
          </document-id>
        </patcit>
      </citation>
      <citation srep-phase="examiner">
        <patcit num="2">
          <text>DUTTWEILER DONALD L</text>
          <document-id>
            <country>US</country>
            <doc-number>5631899</doc-number>
            <kind>A</kind>
          </document-id>
          <document-id data-format="questel">
            <doc-number>US5631899</doc-number>
          </document-id>
        </patcit>
      </citation>
      <citation srep-phase="examiner">
        <patcit num="3">
          <text>FUJII KENSAKU, et al</text>
          <document-id>
            <country>US</country>
            <doc-number>5638311</doc-number>
            <kind>A</kind>
          </document-id>
          <document-id data-format="questel">
            <doc-number>US5638311</doc-number>
          </document-id>
        </patcit>
      </citation>
      <citation srep-phase="examiner">
        <patcit num="4">
          <text>IYENGAR VASU</text>
          <document-id>
            <country>US</country>
            <doc-number>5663955</doc-number>
            <kind>A</kind>
          </document-id>
          <document-id data-format="questel">
            <doc-number>US5663955</doc-number>
          </document-id>
        </patcit>
      </citation>
      <citation srep-phase="examiner">
        <patcit num="5">
          <text>ROMESBURG ERIC DOUGLAS</text>
          <document-id>
            <country>US</country>
            <doc-number>5796819</doc-number>
            <kind>A</kind>
          </document-id>
          <document-id data-format="questel">
            <doc-number>US5796819</doc-number>
          </document-id>
        </patcit>
      </citation>
      <citation srep-phase="examiner">
        <patcit num="6">
          <text>KAWAHARA TOSHIRO, et al</text>
          <document-id>
            <country>US</country>
            <doc-number>5859907</doc-number>
            <kind>A</kind>
          </document-id>
          <document-id data-format="questel">
            <doc-number>US5859907</doc-number>
          </document-id>
        </patcit>
      </citation>
      <citation srep-phase="examiner">
        <patcit num="7">
          <text>OH STEPHEN S</text>
          <document-id>
            <country>US</country>
            <doc-number>5937060</doc-number>
            <kind>A</kind>
          </document-id>
          <document-id data-format="questel">
            <doc-number>US5937060</doc-number>
          </document-id>
        </patcit>
      </citation>
      <citation srep-phase="applicant">
        <patcit num="8">
          <text>TOSHIBA CORP</text>
          <document-id>
            <country>JP</country>
            <doc-number>H088789</doc-number>
            <kind>A</kind>
          </document-id>
          <document-id data-format="questel">
            <doc-number>JP08008789</doc-number>
          </document-id>
        </patcit>
      </citation>
    </references-cited>
    <parties>
      <applicants>
        <applicant data-format="original" app-type="applicant" sequence="1">
          <addressbook lang="en">
            <orgname>Oki Electric Industry Co., Ltd.</orgname>
            <address>
              <address-1>Tokyo, JP</address-1>
              <city>Tokyo</city>
              <country>JP</country>
            </address>
          </addressbook>
          <nationality>
            <country>JP</country>
          </nationality>
        </applicant>
        <applicant data-format="questel" app-type="applicant" sequence="2">
          <addressbook lang="en">
            <orgname>OKI ELECTRIC INDUSTRY</orgname>
          </addressbook>
          <nationality>
            <country>JP</country>
          </nationality>
        </applicant>
      </applicants>
      <inventors>
        <inventor data-format="original" sequence="1">
          <addressbook lang="en">
            <name>Takada, Masashi</name>
            <address>
              <address-1>Tokyo, JP</address-1>
              <city>Tokyo</city>
              <country>JP</country>
            </address>
          </addressbook>
          <nationality>
            <country>JP</country>
          </nationality>
        </inventor>
        <inventor data-format="original" sequence="2">
          <addressbook lang="en">
            <name>Ariyama, Yoshihiro</name>
            <address>
              <address-1>Tokyo, JP</address-1>
              <city>Tokyo</city>
              <country>JP</country>
            </address>
          </addressbook>
          <nationality>
            <country>JP</country>
          </nationality>
        </inventor>
      </inventors>
      <agents>
        <agent sequence="1" rep-type="agent">
          <addressbook lang="en">
            <orgname>Venable</orgname>
          </addressbook>
        </agent>
        <agent sequence="2" rep-type="agent">
          <addressbook lang="en">
            <name>Frank, Robert J.</name>
          </addressbook>
        </agent>
        <agent sequence="3" rep-type="agent">
          <addressbook lang="en">
            <name>Sartori, Michael A.</name>
          </addressbook>
        </agent>
      </agents>
    </parties>
    <examiners>
      <primary-examiner>
        <name>Pham, Chi H.</name>
      </primary-examiner>
    </examiners>
    <lgst-data>
      <lgst-status>EXPIRED</lgst-status>
    </lgst-data>
  </bibliographic-data>
  <abstract format="original" lang="en" id="abstr_en">
    <p id="P-EN-00001" num="00001">
      <br/>
      An echo/noise canceler has an adaptive filter with coefficients that are applied to recent samples of a received signal to generate an echo replica.
      <br/>
      The echo replica is subtracted from a local input signal to create a first residual signal, and local background noise is canceled from the first residual signal to create a second residual signal.
      <br/>
      The echo/noise canceler also stores older samples of the received signal, and uses these older samples and the second residual signal to adjust the coefficients in the adaptive filter.
      <br/>
      The delay between the recent samples and the older samples compensates for the noise cancellation processing delay between the first residual signal and the second residual signal.
    </p>
  </abstract>
  <description format="original" lang="en" id="desc_en">
    <heading>BACKGROUND OF THE INVENTION</heading>
    <p num="1">The present invention relates to an echo/noise canceler for removing echo and noise components from an input signal.</p>
    <p num="2">
      Echo cancelers and noise cancelers are used in voice communication terminals such as videoconferencing terminals, automobile-mounted hands-free telephone sets, and portable telephone sets.
      <br/>
      Unexamined Japanese Patent Application No. 8789/1996 describes a voice communication system in which a noise canceler removes noise components from the output of an echo canceler, and the output of the noise canceler is used in adjusting adaptive filter coefficients in the echo canceler.
      <br/>
      The reason for this arrangement is that use of the output of the noise canceler in adjusting the adaptive filter coefficients enables the residual echo to be reduced to a lower level.
      <br/>
      In a variation of this arrangement, the output of the echo canceler, which is the input of the noise canceler, is used to adjust the adaptive filter coefficients until the residual echo has been reduced to the local background noise level, then the output of the noise canceler is used to achieve a further reduction.
    </p>
    <p num="3">
      A problem in this arrangement is the processing delay of the noise canceler.
      <br/>
      Most recent noise cancelers divide the input signal into frames and process one frame at a time.
      <br/>
      Noise cancelers employing spectral subtraction, for example, operate in this way.
      <br/>
      Spectral subtraction and other frame-based noise cancellation methods have the advantage of high accuracy, but they generate an unavoidable processing delay equal to or greater than the frame length.
    </p>
    <p num="4">
      In the arrangement described above, a long processing delay in the noise canceler can prevent the adaptive filter coefficients in the echo canceler from converging, or can cause the coefficient values to oscillate.
      <br/>
      Further details will be given below.
    </p>
    <heading>SUMMARY OF THE INVENTION</heading>
    <p num="5">It is accordingly an object of the present invention to provide an echo/noise canceler that compensates for the processing delay in the noise canceler.</p>
    <p num="6">Another object of the invention is to achieve a high level of echo reduction.</p>
    <p num="7">Yet another object is to save power.</p>
    <p num="8">
      The invented echo/noise canceler comprises an echo canceler and a noise canceler.
      <br/>
      The echo canceler has an adaptive filter that uses a plurality of coefficients to generate an echo replica from a plurality of recent sample values of a received signal.
      <br/>
      The echo replica is subtracted from a local input signal to cancel an echo of the received signal, generating a first residual signal.
      <br/>
      The noise canceler cancels local background noise in the first residual signal, generating a second residual signal having a certain processing delay with respect to the first residual signal.
    </p>
    <p num="9">The adaptive filter has a sample register that stores the above-mentioned recent sample values of the received signal, a delayed sample register that stores a plurality of older sample values of the received signal, and a coefficient adjuster that adjusts the above-mentioned coefficients on the basis of the older sample values and the second residual signal.</p>
    <p num="10">The echo canceler preferably has a detector that, when the level of local background noise is low, switches off the noise canceler and causes the coefficient adjuster to use the first residual signal and the recent sample values in adjusting the coefficients.</p>
    <p num="11">
      The delay between the sample values stored in the sample register and the sample values stored in the delayed sample register compensates for the processing delay of the noise canceler, so that the coefficient adjustment is carried out consistently.
      <br/>
      Use of the second residual signal then leads to a high level of echo reduction.
    </p>
    <p num="12">Switching off the noise canceler when the local background noise level is low saves power.</p>
    <heading>BRIEF DESCRIPTION OF THE DRAWINGS</heading>
    <p num="13">
      In the attached drawings:
      <br/>
      FIG. 1 is a block diagram of a first embodiment of the invention;
      <br/>
      FIG. 2 is a more detailed block diagram of the adaptive filter in FIG. 1;
      <br/>
      FIG. 3 is a graph showing the results of computer simulations of echo reduction;
      <br/>
      FIG. 4 is a block diagram of a first embodiment of the invention; and
      <br/>
      FIG. 5 is a more detailed block diagram of the adaptive filter in FIG. 4.
    </p>
    <heading>DETAILED DESCRIPTION OF THE INVENTION</heading>
    <p num="14">Embodiments of the invention will be described with reference to the attached example drawings.</p>
    <p num="15">
      Referring to FIG. 1, the first embodiment is an echo/noise canceler operating in a communication device having an input terminal 1 that receives a digital signal X(n) from a distant communication device, a digital-to-analog converter (DAC) 2 that converts the received signal to an analog signal, and a loudspeaker 3 through which the analog signal is reproduced as an acoustic signal.
      <br/>
      Part of the reproduced signal is picked up as an acoustic echo E by a microphone 4, which also picks up local background noise N and speech S. An analog-to-digital converter (ADC) 5 converts the microphone output signal Y to a digitized local input signal Y(n), which is supplied to an echo canceler 6.
    </p>
    <p num="16">The letter `n` is a discrete time variable indicating that, for example, Y(n) is the n-th sample of Y. The sampling frequency is, for example, eight kilohertz (8 kHz) for all of the digital signals shown in the drawing.</p>
    <p num="17">
      The echo canceler 6 comprises a double-talk detector 7, an adaptive filter 8, and an adder 9.
      <br/>
      The adaptive filter 8 comprises a coefficient register 10, an arithmetic circuit 11, a novel delayed sample register 12, a sample register 13, and a coefficient adjuster (COEF. ADJ.) 14. The output of the echo canceler 6 is a first residual signal Er1 (n) in which the components due to the echo (E) have been attenuated.
    </p>
    <p num="18">
      The first residual signal Er1 (n) is supplied to a noise canceler 15, which attenuates components due to the local background noise (N), thereby creating a second residual signal Er2 (n).
      <br/>
      The second residual signal Er2 (n) is supplied to an output terminal 16 and returned to the distant communication device.
    </p>
    <p num="19">FIG. 2 shows the structure of the adaptive filter 8 in more detail.</p>
    <p num="20">
      The coefficient register 10 stores m tap coefficients, where m is a certain positive integer.
      <br/>
      The tap coefficients stored at time n are denoted hj (n), where j is an integer that varies from zero to m-1.
    </p>
    <p num="21">
      The delayed sample register 12 and sample register 13 together form a shift register comprising D-type flip-flops 17 that delay the received signal X(n) by one sample at a time.
      <br/>
      The number of D-type flip-flops 17 is d+m-1, where d is a positive integer equivalent to the processing delay of the noise canceler 15.
      <br/>
      In the drawing, the processing delay d is greater than number of tap coefficients m. The first (m-1) D-type flip-flops 17 constitute the sample register 13; the remaining D-type flip-flops 17 constitute the delayed sample register 12.
    </p>
    <p num="22">
      The output X1 (n) of the first D-type flip-flop 17 is equal to X(n-1).
      <br/>
      The output X2 (n) of the next D-type flip-flop is equal to X(n-2), and so on.
      <br/>
      The received signal X(n) will also be denoted X0 (n).
    </p>
    <p num="23">The arithmetic circuit 11 comprises m multipliers 18 that multiply the sample values Xj (n) stored in the sample register 13 by the tap coefficients hj (n) stored in the coefficient register 10, and m adders 19 that sum the resulting products to generate an echo replica E'(n).</p>
    <p num="24">The coefficient adjuster 14 comprises a power calculator 20, a divider 21, and a coefficient replacer 22.</p>
    <p num="25">Next, the operation of the first embodiment will be described.</p>
    <p num="26">Referring again to FIG. 1, the output Y(n) of the ADC 5 includes a component E(n) due to the echo E, a component N(n) due to the local background noise N, and when the local party is speaking, a component S(n) due to the local party's speech S.</p>
    <p num="27">Y(n)=S(n)+E(n)+N(n)</p>
    <p num="28">From the m most recent samples of the received signal X(n), the adaptive filter 8 predicts the echo component E(n) and generates an echo replica E'(n) according to the following equation.  (Equation image '1' not included in text)</p>
    <p num="29">
      When the tap coefficients hj (n) are properly adjusted, the echo replica E'(n) is substantially equal to the echo component E(n).
      <br/>
      The adder 9 adds the two's complement of the echo replica E'(n) to the output Y(n) of the ADC 5, thereby subtracting E'(n) from Y(n), to obtain the first residual signal Er1 (n).
    </p>
    <p num="30">Er1 (n)=Y(n)-E'(n)=S(n)+E(n)+N(n)-E'(n).tbd.S(n)+N(n)</p>
    <p num="31">
      The noise canceler 15 uses a frame-based method to estimate the noise component N(n), and subtracts the estimated noise component N'(n) from the first residual signal Er1 (n) to obtain the second residual signal Er2 (n).
      <br/>
      Examples of noise cancellation methods that can be used in the noise canceler 15 include, in addition to spectral subtraction, methods employing filter banks or adaptive filters.
      <br/>
      Detailed descriptions of these methods will be omitted.
      <br/>
      The noise canceler 15 can use any frame-based method, regardless of the length of the processing delay d.
    </p>
    <p num="32">
      The processing delay of the noise canceler 15 can be represented as a mathematical operator Zd+ } that subtracts the quantity d from the discrete time variable n of the components inside the braces.
      <br/>
      It is also convenient to indicate the delay by using Er2 (n-d) to denote the output of the noise canceler 15 at the time when Er1 (n) is received as input.
      <br/>
      Thus,
      <br/>
      Er2 (n-d).tbd.Zd+S(n)+N(n)-N'(n)}.tbd.S(n-d)
    </p>
    <p num="33">The distant party accordingly receives the speech component with a delay equal to d, but with negligible contamination by echo and noise.</p>
    <p num="34">
      The double-talk detector 7 receives the received signal X(n), the digitized local input signal Y(n), and the first residual signal Er1 (n).
      <br/>
      The double-talk detector 7 computes an acoustic muting factor ACOM equal, for example, to the power ratio between the received signal X(n) and the first residual signal Er1 (n).
      <br/>
      The double-talk detector 7 compares ACOM with a predetermined threshold THd, compares the power of Er1 (n) with another predetermined threshold THi, compares the power of X(n) with another predetermined threshold THst, and compares the power of the local input signal Y(n) with yet another predetermined threshold Dy.
      <br/>
      On the basis of these comparisons, the double-talk detector 7 determines when and how to adjust the tap coefficients in the adaptive filter 8, and the coefficients used in the noise canceler 15.
    </p>
    <p num="35">
      Double-talk refers to a state in which the distant party and the local party are both talking at once.
      <br/>
      This state is detected when ACOM is less than the threshold THd, and the power of Y(n) exceeds the threshold Dy.
      <br/>
      In the double-talk state, the double-talk detector 7 sends commands to the adaptive filter 8 and noise canceler 15 that halt the adjustment of coefficients.
      <br/>
      Echo cancellation and noise cancellation continue, using the existing coefficient values.
    </p>
    <p num="36">
      When the power of Er1 (n) is greater than the threshold THi and the power of Y(n) is less than the threshold Dy, a situation that occurs when the echo path has infinite loss, the double-talk detector 7 sends the adaptive filter 8 a command that forces the tap coefficients to converge toward zero, and sends the noise canceler 15 a command that clears the coefficients in the noise canceler 15 to zero.
      <br/>
      The purpose of these actions is to avoid the introduction of false background noise and false echo into the residual signals.
      <br/>
      The echo path from the loudspeaker 3 to the microphone 4 is temporarily regarded as non-existent.
    </p>
    <p num="37">
      When ACOM is greater than the threshold THd and the power of the received signal X(n) is greater than the threshold THst, a state that occurs when only the distant party is speaking, the double-talk detector 7 commands the adaptive filter 8 and noise canceler 15 to adjust their coefficients.
      <br/>
      The adaptive filter 8 employs the normalized least mean squares (NLMS) adjustment algorithm, as described later.
      <br/>
      A description of the algorithm used in the noise canceler 15 will be omitted.
      <br/>
      This state is referred to as the single-talk state.
    </p>
    <p num="38">
      When ACOM is less than the threshold THd and the power of X(n) is less than the threshold THst, a state that occurs when only the local party is speaking, the double-talk detector 7 sends commands to the adaptive filter 8 and noise canceler 15 that halt the adjustment of coefficients.
      <br/>
      Echo cancellation and noise cancellation continue, using the existing coefficient values.
    </p>
    <p num="39">When there is a transition from the double-talk state to the single-talk state, the double-talk detector 7 does not immediately command the noise canceler 15 to begin adjusting its coefficients, but waits for a time equivalent to the processing delay d. The reason is that for the duration of this delay d, the noise canceler 15 continues to process the first residual signal Er1 (n) that was generated during the double-talk state.</p>
    <p num="40">When commanded by the double-talk detector 7 to adjust the tap coefficients, the adaptive filter 8 carries out the following operations.</p>
    <p num="41">
      Referring again to FIG. 2, at time n, the delayed sample register 12 holds d samples values from Xm (n) to Xd+m-1 (n).
      <br/>
      These sample values have already been used in generating the echo replica signal and are no longer needed for that purpose.
      <br/>
      The oldest m sample values, from Xd (n) to Xd+m-1 (n), are provided in parallel to the power calculator 20 and divider 21.
      <br/>
      The power calculator 20 computes a received power value P(n) by summing the squares of these m sample values. P(n) is thus calculated according to the following equation.  (Equation image '2' not included in text)
    </p>
    <p num="42">
      The divider 21 divides each of the m sample values from Xd (n) to Xd+m-1 (n) by the received power value P(n), thereby normalizing the sample values.
      <br/>
      At time n, the divider 21 therefore outputs m quotient values PXj (n), where j varies from 0 to m-1.
      <br/>
      The value of PXj (n) is given by the following equation.
    </p>
    <p num="43">PXj (n)=Xi (n)/P(n) (j=i-d)</p>
    <p num="44">
      The values PXj (n) are normalized sample values with an offset of d on the time axis, compensating for the processing delay d of the noise canceler 15.
      <br/>
      The non-normalized values of these samples were the values used in removing echo from the signal that has become the output Er2 (n-d) of the noise canceler 15 at time n.
    </p>
    <p num="45">
      The coefficient replacer 22 uses the output Er2 (n-d) of the noise canceler 15 and the normalized sample values PXj (n) to adjust the tap coefficients hj (n) by the NLMS algorithm.
      <br/>
      The adjustment is given by the following equation, in which  ALPHA  is a step gain, preferably greater than zero but less than one.
      <br/>
      hj (n+1)=hj (n)+ ALPHA PXj (n)Er2 (n-d)
    </p>
    <p num="46">
      Correct alignment of the PXj (n) (j=0 to m-1) with Er2 (n-d) can be verified from the observation that Er2 (n-d), Er1 (n-d) and Y(n-d) all have the same speech component S(n-d), that Er1 (n-d) was obtained by subtracting E'(n-d) from Y(n-d), that E'(n-d) was calculated using Xj (n-d) (j=0 to m-1), that the PXj (n) (j=0 to m-1) are obtained from Xi (n) with j=i-d, hence i=j+d, and that Xi (n) or Xj+d (n) and Xj (n-d) are both equal to X(n-j-d).
      <br/>
      The preceding equations can also be rewritten in the following form.  (Equation image '3' not included in text)
    </p>
    <p num="47">
      Although the processing delay d can have any value, the value of d will not differ greatly from the frame length used in noise cancellation in the noise canceler 15.
      <br/>
      The frame length is selected so that during the duration of one frame, the characteristics of the local background noise are unlikely to change significantly.
      <br/>
      During a frame of this length, the characteristics of the echo path from the loudspeaker 3 to the microphone 4 are also unlikely to change significantly, so the delay d in the values Xj (n-d) and Er2 (n-d) used in adjusting the tap coefficients does not prevent the adaptive filter 8 from creating an accurate echo replica E'(n).
    </p>
    <p num="48">
      The inventors have tested the effect of the first embodiment by computer simulation, obtaining the results shown in FIG. 3.
      <br/>
      The horizontal axis represents discrete time in units of one sample, or one eight-thousandth of a second.
      <br/>
      The vertical axis represents the echo muting factor ACOM in decibels.
      <br/>
      The received signal X was a Gaussian noise signal or white-noise signal.
      <br/>
      The intrinsic attenuation of the echo path from the loudspeaker 3 to the microphone 4 was set at fifteen decibels (15 dB).
      <br/>
      The sound of a running automobile engine was used as the local background noise N. The echo-to-noise power ratio at the microphone 4 was set at fifteen decibels.
      <br/>
      Noise cancellation was performed by spectral subtraction with a frame length of two hundred fifty-six samples, reducing the local background noise power by fifteen decibels.
    </p>
    <p num="49">
      The NLMS algorithm is known to reduce echo to the level of local background noise present in the residual signal employed in the adjustment of the tap coefficients.
      <br/>
      Under the simulation conditions, since the echo-to-noise ratio was fifteen decibels at the microphone 4 and the noise canceler 15 reduced the noise level by a further fifteen decibels, the echo canceler 6 was expected to attenuate the echo by thirty decibels.
      <br/>
      The expected value of ACOM was this thirty decibels, plus the intrinsic fifteen-decibel attenuation of the echo path, or forty-five decibels.
      <br/>
      As the tap coefficients converged, this expected result was indeed obtained, as shown by the upper curve 23.
    </p>
    <p num="50">
      The accuracy of the simulation was tested in a second run with the noise canceler 15 disabled.
      <br/>
      The expected value of ACOM was now only thirty decibels, because the tap coefficients were being adjusted on the basis of a residual signal in which the local background noise level was fifteen decibels higher than before.
      <br/>
      This result was also confirmed, as shown by the middle curve 24.
    </p>
    <p num="51">
      As a test of the prior art, a third simulation was run with the noise canceler 15 enabled, but without making use of the delayed sample register 12.
      <br/>
      The power calculator 20 and divider 21 were provided with the sample values X0 (n) to Xm-1 (n) held in the sample register 13, instead of the sample values Xd (n) to Xm-d-1 (n) output by the delayed sample register 12.
      <br/>
      The value of ACOM was found to drift downward from the initial fifteen-decibel attenuation provided by the echo path, as shown by the bottom curve 25.
      <br/>
      The echo canceler was not only failing to cancel the echo, but was generating unwanted noise of its own.
    </p>
    <p num="52">The conclusion that can be drawn from FIG. 3 is that when a substantial processing delay d is present, the first embodiment enables the tap coefficients to converge correctly, while the prior art does not permit the tap coefficients to converge at all.</p>
    <p num="53">Next, a second embodiment of the invention will be described.</p>
    <p num="54">
      FIG. 4 shows the second embodiment, using the same reference numerals as in FIG. 1 for identical or equivalent elements.
      <br/>
      The new element in the second embodiment is a single-pole double-throw switch 26 that selects either the first residual signal Er1 (n) or the second residual signal Er2 (n) for input to the coefficient adjuster 14 in the adaptive filter 8.
      <br/>
      The selection is made in response to a mode signal M from the double-talk detector 7.
      <br/>
      The mode of operation in which the switch 26 selects the second residual signal Er2 (n) will be referred to below as the first mode.
      <br/>
      The mode of operation in which the switch 26 selects the first residual signal Er1 (n) will be referred to as the second mode.
    </p>
    <p num="55">
      FIG. 5 shows the detailed structure of the adaptive filter 8 in the second embodiment, using the same reference numerals as in FIG. 2 for identical elements.
      <br/>
      The coefficient adjuster 14 has, in addition to the elements shown in FIG. 2, four m-pole single-throw switches 27, 28, 29, and 30.
      <br/>
      In their closed states, switch 27 couples the outputs of the sample register 13 to the power calculator 20, switch 28 couples the outputs of the delayed sample register 12 to the power calculator 20, switch 29 couples the outputs of the sample register 13 to the divider 21, and switch 30 couples the outputs of the delayed sample register 12 to the divider 21.
      <br/>
      In the first mode of operation, switches 27 and 29 are open and switches 28 and 30 are closed.
      <br/>
      In the second mode of operation, switches 27 and 29 are closed and switches 28 and 30 are open.
    </p>
    <p num="56">Next, the operation of the second embodiment will be described, starting with a description of the way in which the double-talk detector 7 decides between the first and second modes.</p>
    <p num="57">
      Initially, the double-talk detector 7 selects the first mode.
      <br/>
      During operation in either the first or second mode, the double-talk detector 7 calculates the ratio of the power of the received signal X(n) to the power of the first residual signal Er1 (n), and compares this ratio with a predetermined threshold TH1, such as forty-five decibels (45 dB).
      <br/>
      If this ratio exceeds the threshold TH1, the double-talk detector 7 switches to the second mode.
      <br/>
      When the ratio falls below the threshold TH1, the double-talk detector 7 switches back to the first mode.
    </p>
    <p num="58">
      In the first mode, the coefficient adjuster 14 receives the second residual signal Er2 (n) from switch 26, and the power calculator 20 and divider 21 receive sample values Xd (n) to Xd+m-1 (n) from switches 28 and 30.
      <br/>
      The second embodiment accordingly operates in the same way as the first embodiment, maintaining consistency on the time axis by taking the processing delay d into account.
    </p>
    <p num="59">In the second mode, the power calculator 20 calculates the power P(n) of the received signal from the m most recent sample values Xj (m), where j varies from zero to m-1, these values being obtained from switch 27.  (Equation image '4' not included in text)</p>
    <p num="60">The divider 21 divides these m most recent sample values, obtained from switch 29, by P(n) to obtain normalized values PXj (n), where j varies from zero to m-1.</p>
    <p num="61">PXj (n)=Xj (n)/P(n)</p>
    <p num="62">
      The coefficient replacer 22 adjusts the tap coefficients hj (n) by the NLMS algorithm, using the first residual signal Er1 (n) instead of the second residual signal Er2 (n-d).
      <br/>
      Again, j varies from zero to m-1.
      <br/>
      hj (n+1)=hj (n)+ ALPHA PXj (n)Er1 (n)
    </p>
    <p num="63">Because the Xj (n), where j varies from zero to m-1, are the values that figured in the computation of Er1 (n), the operation in the second mode is also consistent on the time axis.</p>
    <p num="64">
      As noise has not yet been canceled in the first residual signal Er1 (n), a high value of the power ratio of X(n) to Er1 (n) indicates a relatively low level of local background noise.
      <br/>
      In the second mode, in which this ratio exceeds the threshold TH1, the level of local background noise is considered to be so low as not to require noise cancellation.
      <br/>
      Accordingly, the double-talk detector 7 switches off the noise canceler 15 in the second mode, making the second residual signal equal to the first residual signal Er1 (n).
    </p>
    <p num="65">Other aspects of operation in the second mode are the same as in the first mode.</p>
    <p num="66">In the first mode, by compensating for the processing delay of the noise canceler 15, the second embodiment provides the same effects as the first embodiment.</p>
    <p num="67">
      In the second mode, the second embodiment operates as if the noise canceler 15 were not present.
      <br/>
      Turning off the noise canceler 15 in the second mode saves power.
      <br/>
      In a portable telephone set, the talk time is extended.
    </p>
    <p num="68">
      The present invention is not limited to the embodiments described above.
      <br/>
      For example, the noise canceler 15 does not have to employ frame-based processing.
      <br/>
      The invention is applicable with any type of noise canceler in which a processing delay occurs.
    </p>
    <p num="69">
      The adaptive filter 8 does not have to employ the NLMS algorithm for adjustment of the tap coefficients.
      <br/>
      Any algorithm that permits the tap coefficients to be adjusted on the basis of the received signal X(n) and the output of the noise canceler 15 can be employed.
    </p>
    <p num="70">
      The delayed sample register 12 and sample register 13 do not have to be configured as a continuous series of D-type flip-flops.
      <br/>
      The delayed sample register 12 and sample register 13 can be configured separately, for example.
    </p>
    <p num="71">If the delay d is shorter than the time over which significant changes in the power of the received signal X(n) occur, then in the first embodiment, and in the first mode of operation of the second embodiment, the power P(n) of the received signal can be calculated from the most recent m samples, instead of using the delayed sample values output by the delayed sample register 12.</p>
    <p num="72">
      In the first embodiment, the double-talk detector 7 can use the second residual signal Er2 (n) instead of the first residual signal Er1 (n) to compute the power ratio ACOM.
      <br/>
      Alternatively, instead of a power ratio, the double-talk detector 7 can compute a power difference, or an amplitude level ratio, or an amplitude level difference, or perform any other computations by which the single-talk, double-talk, and other relevant states can be recognized.
    </p>
    <p num="73">
      In the second embodiment, the double-talk detector 7 can determine when to switch from the first mode to the second mode by calculating the power ratio of the received signal X(n) to the second residual signal Er2 (n).
      <br/>
      Alternatively, the double-talk detector 7 can decide when to switch modes by comparing the power level of the first residual signal Er1 (n) directly with a threshold, without calculating a power ratio.
    </p>
    <p num="74">Those skilled in the art will recognize that further variations are possible within the scope claimed below.</p>
  </description>
  <claims format="original" lang="en" id="claim_en">
    <claim num="1">
      <claim-text>What is claimed is:</claim-text>
      <claim-text>1.</claim-text>
      <claim-text>A method of adjusting coefficients in an echo/noise canceler that receives a received signal and a local input signal, uses said coefficients and a plurality of recent samples of said received signal to generate an echo replica, subtracts the echo replica from the local input signal to create a first residual signal, and cancels local background noise from the first residual signal to create a second residual signal, producing a certain processing delay between the first residual signal and the second residual signal, comprising the steps of:</claim-text>
      <claim-text>storing a plurality of older sample values of said received signal, said older sample values being delayed with respect to said recent sample values by an amount corresponding to said processing delay;</claim-text>
      <claim-text>and adjusting said coefficients according to said older sample values and said second residual signal.</claim-text>
    </claim>
    <claim num="2">
      <claim-text>2. The method of claim 1, wherein said step of storing comprises shifting said received signal through a shift register, said recent sample values and said older sample values both being obtained as outputs of said shift register.</claim-text>
    </claim>
    <claim num="3">
      <claim-text>3. The method of claim 1, further comprising the steps of: detecting a level of said local background noise;</claim-text>
      <claim-text>and adjusting said coefficients according to said recent sample values and said first residual signal when the level of said local background noise is below a certain threshold.</claim-text>
    </claim>
    <claim num="4">
      <claim-text>4. The method of claim 3, further comprising the step of ceasing to cancel said local background noise from said first residual signal when the level of said local background noise is below said threshold.</claim-text>
    </claim>
    <claim num="5">
      <claim-text>5. An echo/noise canceler having an echo canceler and a noise canceler, the echo canceler receiving a received signal and a local input signal, generating an echo replica from the received signal, and subtracting the echo replica from the local input signal to create a first residual signal, the noise canceler removing local background noise from the first residual signal to create a second residual signal, and the noise canceler also producing a certain processing delay between the first residual signal and the second residual signal, the echo canceler having an adaptive filter comprising: a sample register for storing a plurality of recent sample values of said received signal; a coefficient register for storing a plurality of coefficients; an arithmetic circuit coupled to said coefficient register and said sample register, for generating said echo replica from said recent sample values and said coefficients; a delayed sample register for storing a plurality of older sample values of said received signal, said older sample values being delayed with respect to said recent sample values by an amount corresponding to said processing delay;</claim-text>
      <claim-text>and a coefficient adjuster coupled to said coefficient register, said delayed sample register, and said noise canceler, operating in at least a first mode, in which said coefficient adjuster adjusts said coefficients according to said older sample values and said second residual signal.</claim-text>
    </claim>
    <claim num="6">
      <claim-text>6. The echo/noise canceler of claim 5, wherein said delayed sample register and said sample register together form a single shift register through which said received signal is shifted.</claim-text>
    </claim>
    <claim num="7">
      <claim-text>7. The echo/noise canceler of claim 5, further comprising: a detector that detects a level of said local background noise, and generates a mode signal indicating whether said level is high or low;</claim-text>
      <claim-text>and a switch coupled to said detector, for selecting said first residual signal when said level is low, selecting said second residual signal when said level is high, and supplying the selected residual signal to said coefficient adjuster;</claim-text>
      <claim-text>wherein when said mode signal indicates that the level of said local background noise is low, said coefficient adjuster operates in a second mode, in which said coefficient adjuster adjusts said coefficients according to said recent sample values and said first residual signal.</claim-text>
    </claim>
    <claim num="8">
      <claim-text>8. The echo/noise canceler of claim 7, wherein said detector switches off said noise canceler when the level of said local background noise is low.</claim-text>
    </claim>
  </claims>
</questel-patent-document>